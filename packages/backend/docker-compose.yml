# Sentinel Grid - Docker Compose
# Run: docker-compose up --build

version: '3.8'

services:
  backend:
    build: .
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - API_KEY=${API_KEY:-demo-api-key}
      - DB_PATH=/app/data/sentinel.db
      - SIMULATION_SEED=12345
      - NODE_COUNT=200
      - PIN_HMAC_KEY=${PIN_HMAC_KEY:-demo-hmac-key}
      - WEB3STORAGE_TOKEN=${WEB3STORAGE_TOKEN:-}
      - HARDHAT_RPC=http://hardhat:8545
    volumes:
      - sentinel-data:/app/data
    depends_on:
      - hardhat
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  hardhat:
    image: node:20-alpine
    working_dir: /app
    command: npx hardhat node --hostname 0.0.0.0
    ports:
      - "8545:8545"
    volumes:
      - ./contracts:/app
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:8545"]
      interval: 30s
      timeout: 10s
      retries: 3

  ipfs:
    image: ipfs/kubo:latest
    ports:
      - "5001:5001"
      - "8080:8080"
    volumes:
      - ipfs-data:/data/ipfs
    environment:
      - IPFS_PROFILE=server
    profiles:
      - full

volumes:
  sentinel-data:
  ipfs-data:

networks:
  default:
    name: sentinel-grid
